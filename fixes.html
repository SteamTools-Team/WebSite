<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Online Fixes - SteamTools</title>
<link rel="stylesheet" href="assets/style.css">
<style>
/* Ajustements sp√©cifiques √† la grille des fixes, en r√©utilisant les variables globales */
.container{max-width:1100px;}
#controls{display:flex;gap:10px;justify-content:center;margin:20px 0;}
#search{flex:1;max-width:420px;padding:10px 14px;border-radius:10px;border:1px solid var(--border-color);background:var(--accent-bg);color:var(--text-primary);}
#reload{padding:10px 18px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--violet-primary),var(--violet-hover));color:white;font-weight:600;cursor:pointer;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;margin-top:20px;}
.card{background:var(--accent-bg);border:1px solid var(--border-color);border-radius:14px;overflow:hidden;text-decoration:none;color:inherit;transition:.25s ease;}
.card:hover{transform:translateY(-3px);box-shadow:0 10px 28px rgba(140,122,230,.25),0 0 0 1px rgba(168,153,249,.2) inset;} 
.card .info{padding:12px;}
.file-row{display:flex;align-items:center;gap:4px;min-height:56px;}
.file-text{display:flex;flex-direction:column;gap:3px;flex:1;min-width:0;margin-left:-6px;}
.file-icon{width:64px;height:64px;border:1px solid var(--border-color);background:linear-gradient(180deg,#1c1c2e,#151525);border-radius:14px;display:flex;align-items:center;justify-content:center;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);} 
.file-icon img{width:36px;height:36px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(140,122,230,.35));} 
.filename{font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:1.02rem;}
.size{display:inline-flex;align-items:center;gap:6px;font-size:.8rem;color:var(--text-primary);background:rgba(168,153,249,.08);border:1px solid var(--border-color);padding:5px 12px;border-radius:999px;width:fit-content;align-self:flex-start;}
.card:hover .file-icon{border-color:var(--violet-hover);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),0 0 0 3px rgba(168,153,249,.18);} 
.card:hover .filename{color:var(--violet-hover);} 
.empty{text-align:center;color:var(--text-secondary);margin-top:40px;}
</style>
</head>
<body>
<div class="container">
  <h1>üéÆ Fixes List</h1>
  <div id="controls">
    <input id="search" type="search" placeholder="Search a game...">
    <button id="reload">Reload</button>
  </div>
  <div id="content"></div>
</div>

<script>
const SOURCE_URL = "https://generator.ryuu.lol/fixes";
const CACHE_KEY = "fixes-cache";
const CACHE_TTL = 3600 * 1000; // 1 heure
const DEFAULT_ICON = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4c1.svg"; // ic√¥ne dossier

let allFixes = [];

const PROXIES = [
  url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://thingproxy.freeboard.io/fetch/${url}`,
];

async function fetchViaProxies(url){
  for(const make of PROXIES){
    try{
      const r = await fetch(make(url));
      if(!r.ok) continue;
      const type = r.headers.get("content-type")||"";
      if(type.includes("json")){
        const j = await r.json();
        return j.contents || j; // allorigins renvoie { contents }
      } else {
        return await r.text();
      }
    }catch(_){/* essaie le proxy suivant */}
  }
  throw new Error("Unable to fetch source page");
}

async function fetchJsonViaProxies(url){
  for(const make of PROXIES){
    try{
      const r = await fetch(make(url));
      if(!r.ok) continue;
      const type = r.headers.get('content-type')||'';
      if(type.includes('json')){
        const j = await r.json();
        const contents = j && typeof j==='object' && 'contents' in j ? j.contents : j;
        if(typeof contents === 'string'){
          try{ return JSON.parse(contents); }catch{ continue; }
        }
        return contents;
      } else {
        const t = await r.text();
        try{ return JSON.parse(t); }catch{ continue; }
      }
    }catch(_){/* essaie proxy suivant */}
  }
  throw new Error('Unable to fetch JSON via proxies');
}

function parseFixes(html){
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const anchors = [...doc.querySelectorAll("a.file-item, a[href$='.zip']")];
  return anchors.map(a=>{
    const name = (a.querySelector('.file-name')?.textContent || a.textContent || '').trim();
    const href = a.getAttribute('href') || '';
    let absoluteUrl = href;
    try { absoluteUrl = new URL(href, SOURCE_URL).toString(); } catch {}
    const size = (a.querySelector('.file-size')?.textContent || '').trim();
    return { name, url: absoluteUrl, size };
  }).filter(f=> (f.name||'').toLowerCase().includes('.zip'));
}

// R√©cup√®re un appid Steam depuis la recherche du store via r.jina.ai (CORS OK)
async function getAppIdFromSteamStore(name){
  try{
    const q = encodeURIComponent(name);
    const url = `https://r.jina.ai/http://store.steampowered.com/search/?term=${q}`;
    const text = await fetchViaProxies(url); // renvoie du texte lisible
    const m = String(text||"").match(/\/app\/(\d+)/);
    return m ? m[1] : null;
  }catch{
    return null;
  }
}

function getSteamImage(){ return null; }

function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

function render(list){
  const q=document.getElementById("search").value.toLowerCase();
  const safeList=Array.isArray(list)?list:[];
  const items=safeList.filter(i=>!q||i.name.toLowerCase().includes(q));
  if(!items.length)return document.getElementById("content").innerHTML=`<div class="empty">No files found.</div>`;
  document.getElementById("content").innerHTML=`<div class="grid">`+items.map(it=>`
    <a href="${it.url}" target="_blank" class="card">
      <div class="info">
        <div class="file-row">
          <span class="file-icon"><img src="${DEFAULT_ICON}" alt="" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='${DEFAULT_ICON}';"></span>
          <span class="file-text">
            <span class="filename">${escapeHtml(it.name)}</span>
            <span class="size">${escapeHtml(it.size||"")}</span>
          </span>
        </div>
      </div>
    </a>`).join("")+`</div>`;
}

async function fetchFixes(force=false){
  const cache=localStorage.getItem(CACHE_KEY);
  if(cache&&!force){
    const data=JSON.parse(cache);
    if(Date.now()-data.timestamp<CACHE_TTL){
      allFixes=Array.isArray(data.fixes)?data.fixes:[];
      // plus de r√©cup√©ration d'images
      render(allFixes);
      console.log("üíæ Cache loaded");
      return;
    }
  }
  document.getElementById("content").innerHTML=`<div class="empty">Loading...</div>`;
  try{
    const html = await fetchViaProxies(SOURCE_URL);
    let fixes = parseFixes(typeof html === 'string' ? html : String(html||''));
    console.log(`üì¶ ${fixes.length} fixes found`);
    // plus de r√©cup√©ration d'images afin d'√©viter les surcharges r√©seau
    allFixes = fixes;
    localStorage.setItem(CACHE_KEY,JSON.stringify({timestamp:Date.now(),fixes:allFixes}));
    render(allFixes);
    console.log("‚ö° Cache updated");
  }catch(e){
    console.error(e);
    let msg = e;
    if(e&&typeof e==='object') msg = e.message||e.error||e.toString();
    if(typeof msg!=='string') { try{ msg = JSON.stringify(msg); }catch{ msg = 'Unknown error'; } }
    document.getElementById("content").innerHTML=`<div class="empty">Error loading fixes: ${escapeHtml(String(msg))}</div>`;
  }
}

document.getElementById("search").oninput=()=>render(allFixes);
document.getElementById("reload").onclick=()=>fetchFixes(true);

fetchFixes();
</script>
</body>
</html>
